services:
  openclaw-gateway:
    image: ghcr.io/openclaw/openclaw:2026.2.17
    container_name: openclaw-gateway
    restart: unless-stopped
    init: true
    ports:
      # HARDENED: bind to localhost ONLY — never 0.0.0.0
      - "127.0.0.1:18789:18789"
    read_only: true
    tmpfs:
      # /tmp needs exec for Chrome crashpad handler
      - /tmp:size=100M,nosuid,nodev
      - /var/tmp:size=50M,noexec,nosuid,nodev
      - /run:size=10M,noexec,nosuid,nodev
      # Chrome needs writable dirs for NSS keystore and fontconfig cache (uid=1000 = node user)
      - /home/node/.pki:size=10M,uid=1000,gid=1000
      - /home/node/.cache/fontconfig:size=10M,uid=1000,gid=1000
      - /var/cache/fontconfig:size=10M,uid=1000,gid=1000
    volumes:
      # Config and state
      - ${HOME}/.openclaw:/home/node/.openclaw:rw
      # Agent workspace
      - ${HOME}/openclaw/workspace:/home/node/.openclaw/workspace:rw
      # Local skills — mounted READ-ONLY
      - ${HOME}/openclaw/local-skills:/home/node/.openclaw/local-skills:ro
      # ClawdTalk needs RW for PID files, logs, and node_modules
      - ${HOME}/openclaw/local-skills/clawdtalk:/home/node/.openclaw/local-skills/clawdtalk:rw
      # NEAR Intents helper — mounted READ-ONLY (the skill invokes this)
      - ${HOME}/openclaw/near-intents-helper:/opt/near-intents-helper:ro
      # NOTE: secrets dir NO LONGER mounted — credentials injected via env vars
      # gogcli binary — Linux ARM64 build, mounted READ-ONLY into PATH
      - ${HOME}/openclaw/bin/gog-linux-arm64:/usr/local/bin/gog:ro
      # jq binary — needed by ClawdTalk shell scripts
      - ${HOME}/openclaw/bin/jq:/usr/local/bin/jq:ro
      # gogcli config/token store
      - ${HOME}/.openclaw/gogcli:/home/node/.config/gogcli:rw
      # Playwright browser binaries (Chromium for browser automation)
      - ${HOME}/.openclaw/playwright:/home/node/.cache/ms-playwright:rw
      # Chromium shared libraries (browser deps not in base image)
      - ${HOME}/.openclaw/browser-libs:/usr/lib/chromium-libs:ro
      # Nyx DeFi state (portfolio, positions, strategy logs)
      - ${HOME}/.openclaw/defi-state:/home/node/.openclaw/defi-state:rw
      # NOTE: 402 billing-patch removed — file hashes changed in 2026.2.17.
      # Monitor for recurrence; if needed, re-patch new file names.
    env_file:
      - docker.env
    environment:
      - OPENCLAW_GATEWAY_BIND=localhost
      - OPENCLAW_CONFIG_PATH=/home/node/.openclaw/openclaw.json
      - LD_LIBRARY_PATH=/usr/lib/chromium-libs
      - http_proxy=http://egress-proxy:3128
      - https_proxy=http://egress-proxy:3128
      - no_proxy=localhost,127.0.0.1,signal-cli
      # Cross-chain support
      - CROSS_CHAIN_ENABLED=true
      - ONECLICK_API_URL=https://1click.chaindefuser.com/v0
      # Privacy: ZEC as default crypto layer
      - ZEC_PRIVACY_DEFAULT=true
    depends_on:
      - egress-proxy
    command: ["sh", "-c", "rm -f /home/node/.openclaw/browser/*/user-data/Singleton* 2>/dev/null; exec node dist/index.js gateway --bind lan --port 18789"]
    user: "1000:1000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    mem_limit: 2g
    cpus: 2
    pids_limit: 256
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - openclaw-net

  # ── Egress Proxy (domain allowlist) ──
  egress-proxy:
    image: ubuntu/squid:latest
    container_name: egress-proxy
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /var/spool/squid:size=100M
      - /var/log/squid:size=50M
      - /run:size=10M
    volumes:
      - ${HOME}/openclaw/squid.conf:/etc/squid/squid.conf:ro
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
    mem_limit: 256m
    cpus: 0.5
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - openclaw-net

  openclaw-cli:
    image: ghcr.io/openclaw/openclaw:2026.2.17
    container_name: openclaw-cli
    profiles: ["cli"]
    stdin_open: true
    tty: true
    init: true
    read_only: true
    tmpfs:
      - /tmp:size=100M,noexec,nosuid,nodev
    volumes:
      - ${HOME}/.openclaw:/home/node/.openclaw:rw
      - ${HOME}/openclaw/workspace:/home/node/.openclaw/workspace:rw
      - ${HOME}/openclaw/local-skills:/home/node/.openclaw/local-skills:ro
      - ${HOME}/openclaw/local-skills/clawdtalk:/home/node/.openclaw/local-skills/clawdtalk:rw
      - ${HOME}/openclaw/near-intents-helper:/opt/near-intents-helper:ro
      - ${HOME}/openclaw/bin/gog-linux-arm64:/usr/local/bin/gog:ro
      - ${HOME}/openclaw/bin/jq:/usr/local/bin/jq:ro
      - ${HOME}/.openclaw/gogcli:/home/node/.config/gogcli:rw
      - ${HOME}/.openclaw/defi-state:/home/node/.openclaw/defi-state:rw
    env_file:
      - docker.env
    environment:
      - OPENCLAW_CONFIG_PATH=/home/node/.openclaw/openclaw.json
    entrypoint: ["node", "dist/index.js"]
    user: "1000:1000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    networks:
      - openclaw-net

networks:
  openclaw-net:
    driver: bridge
